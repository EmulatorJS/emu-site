<html>
    <head>
        <link rel="stylesheet" href="/main.css">
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-R87E52EEFR"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-R87E52EEFR');
        </script>
    </head>
    <body>
        <nav class="navMenu"> <!-- Navigation bar -->
            <a href="/" class="blockA">Home</a>
            <a href="/download.html" class="blockA">Download</a>
            <a href="https://github.com/ethanaobrien/emulatorjs" class="blockA">View on github</a>
            <div class="dropdown">
                <button class="dropbtn">Systems</button>
                <div class="dropdown-content">
                    <!-- In progress -->
                </div>
            </div>
        </nav>
        <noscript>
            <h2>To use the code creator, please enable javascript</h2>
        </noscript>
        <br>
        <a class="blockB" id="start">Start Creating</a>
        <ul id="systemSelect" style="display:none;">
            <h1>Select System</h1>
            <ul id="radioContainer"></ul>
            <a class="blockB" id="systemSelected" style="float:right;margin:20px;">Next ></a>
        </ul>
        <ul id="select2" style="display:none;">
            <ul>
                <label class="textBox">Game Rom:
                    <input type="file" id="gameRom">
                </label>
                <br>
                <label class="container" id="sgol">Start Game On Page Load
                    <input type="checkbox" id="startOnLoad">
                    <span class="checkmark2"></span>
                </label>
                <label class="container" style="display:none;" id="sm">SNES Mouse
                    <input type="checkbox" id="snesMouse">
                    <span class="checkmark2"></span>
                </label>
                <label class="container" style="display:none;" id="smt">SNES Multitap
                    <input type="checkbox" id="snesMultiTap">
                    <span class="checkmark2"></span>
                </label>
                <label class="container" style="display:none;" id="lg">Lightgun
                    <input type="checkbox" id="lightgun">
                    <span class="checkmark2"></span>
                </label>
                <div id="np" style="display:none;">
                    <label class="container">Netplay
                        <input type="checkbox" id="netplay">
                        <span class="checkmark2"></span>
                    </label>
                    <br>
                    <label class="textBox" style="display:none;" id="npgid">Game Id
                        <input type="number" id="npGameId">
                    </label>
                </div>
                <label class="container">Make it work offline (no web server required) not recommended
                    <input type="checkbox" id="offline">
                    <span class="checkmark2"></span>
                </label>
                <label class="container" style="op">Pack into single file
                    <input type="checkbox" id="offlinePack">
                    <span class="checkmark2"></span>
                </label>
                <div id="pathToData">
                    <label class="container">Use Local path to Data
                        <input type="checkbox" id="p2d">
                        <span class="checkmark2"></span>
                    </label>
                    <br>
                    <label class="textBox" style="display:none;" id="ptwod">Path To Data Folder (on your server)
                        <input type="text" id="path2Data">
                    </label>
                </div>
                <br>
                <label class="textBox">Name Of Game (for save files)
                    <input type="text" id="nameOfGame">
                </label>
                <br>
                <label class="textBox">Ad Url
                    <input type="text" id="adUrl">
                </label>
                <br>
                <label class="textBox">Hex Color theme
                    <input type="text" id="ejsColor">
                </label>
                <br>
                <label class="textBox" style="display:none;" id="bf">Bios File:
                    <input type="file" id="biosFile">
                </label>
                <br>
                <label class="textBox" id="ss">Save state (to be loaded on start)
                    <input type="file" id="stateOnLoad">
                </label>
                <div id="errors"></div>
            </ul>
            <a class="blockB" id="generateFile" style="float:right;margin:20px;">Generate Out File</a>
        </ul>
        <ul id="zipStatus" style="display:none;">
            <label for="zs1">Zipping</label>
            <progress id="zs1" value="0" max="100"> 0% </progress>
            <br>
            <p id="zs2"></p>
        </ul>
        <ul id="downloadScreen" style="display:none;">
            <p>FINISHED: <a id="outLink">Click to download.</a></p>
        </ul>
        <script src="systems.js"></script>
        <script src="jszip.js"></script>
        <script>
            window.addEventListener('load', function() {
                var radioContainer = document.getElementById('radioContainer')
                var labelHTML = '';
                for (var i=0; i<systems.length; i++) {
                    labelHTML += '<label class="container">'+systems[i].name+'\n<input type="radio" name="systemSelect" value='+systems[i].core+'>\n<span class="checkmark"></span>\n</label>'
                }
                radioContainer.innerHTML = labelHTML
            })
            var startBtn = document.getElementById('start');
            var systemSelect = document.getElementById('systemSelect');
            var select2 = document.getElementById('select2');
            document.getElementById('start').addEventListener('click', function(e) {
                startBtn.style = "display:none;"
                systemSelect.style = "display:block;"
            })
            document.getElementById('p2d').addEventListener('change', function(e) {
                document.getElementById('ptwod').style = (document.getElementById('p2d').checked ? 'display:block;' : 'display:none');
            })
            document.getElementById('netplay').addEventListener('change', function(e) {
                document.getElementById('npgid').style = (document.getElementById('netplay').checked ? 'display:block;' : 'display:none');
            })
            document.getElementById('offline').addEventListener('change', function(e) {
                document.getElementById('pathToData').style = (document.getElementById('offline').checked ? 'display:none;' : 'display:block');
                document.getElementById('op').style = (document.getElementById('offline').checked ? 'display:none;' : 'display:block');
                document.getElementById('bf').style = (document.getElementById('offline').checked ? 'display:none;' : 'display:block');
                document.getElementById('ss').style = (document.getElementById('offline').checked ? 'display:none;' : 'display:block');
            })
            document.getElementById('systemSelected').addEventListener('click', function(e) {
                var q = null;
                var radios = document.getElementsByName('systemSelect');
                for (var i=0; i<radios.length; i++) {
                    if (radios[i].checked) {
                        var q = radios[i].value;
                        break;
                    };
                };
                if (q === null) {return};
                for (var i=0; i<systems.length; i++) {
                    if (systems[i].core === q) {
                        q = systems[i]
                        break
                    }
                }
                if (q.netplay) {
                    document.getElementById('np').style = "display:block;"
                }
                if (q.lightgun) {
                    document.getElementById('lg').style = "display:block;"
                }
                if (q.bios) {
                    document.getElementById('bf').style = "display:block;"
                }
                if (q.mouse) {
                    document.getElementById('sm').style = "display:block;"
                }
                if (q.multitap) {
                    document.getElementById('smt').style = "display:block;"
                }
                window.selectedCoreData = q;
                window.scrollTo(0, 0);
                systemSelect.style = "display:none;"
                select2.style = "display:block;"
            })
            document.getElementById('generateFile').addEventListener('click', async function(e) {
                var data = {}
                var zip = new JSZip();
                var file = document.getElementById('gameRom').files[0]
                var ejsColor = document.getElementById('ejsColor')
                var errors = document.getElementById('errors')
                var npGameId = document.getElementById('npGameId')
                var path2Data = document.getElementById('path2Data')
                var biosFile = document.getElementById('biosFile')
                var offline = document.getElementById('offline')
                var stateOnLoad = document.getElementById('stateOnLoad')
                if (ejsColor.value && ejsColor.value.trim() !== '') {
                    if (!/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(ejsColor.value)) {
                        errors.innerHTML = '<p><span style="color:red;font-size:25px;">An error occured When Generating</span></p><ul><li>Color theme is not hex value</li></ul>'
                        return
                    }
                }
                if (! file) {
                    errors.innerHTML = '<p><span style="color:red;font-size:25px;">An error occured When Generating</span></p><ul><li>No rom file selected</li></ul>'
                    return
                }
                var gameName = (document.getElementById('nameOfGame').value && document.getElementById('nameOfGame').value.trim() !== '') ? document.getElementById('nameOfGame').value : file.name;
                data['EJS_player'] = '#game';
                data['EJS_core'] = window.selectedCoreData.core;
                if (document.getElementById('snesMouse').checked) {
                    data['EJS_mouse'] = true;
                }
                if (document.getElementById('snesMultiTap').checked) {
                    data['EJS_multitap'] = true;
                }
                if (document.getElementById('nameOfGame').value && document.getElementById('nameOfGame').value.trim() !== '') {
                    data['EJS_gameName'] = document.getElementById('nameOfGame').value;
                }
                if (document.getElementById('adUrl').value && document.getElementById('adUrl').value.trim() !== '') {
                    data['EJS_AdUrl'] = document.getElementById('adUrl').value;
                }
                if (ejsColor.value && ejsColor.value.trim() !== '') {
                    data['EJS_color'] = ejsColor.value;
                }
                if (document.getElementById('startOnLoad').checked) {
                    data['EJS_startOnLoaded'] = true;
                }
                if (document.getElementById('netplay').checked && npGameId.value && npGameId.value.trim() !== '') {
                    data['EJS_gameID'] = npGameId.value;
                }
                if (document.getElementById('p2d').checked && path2Data.value && path2Data.value.trim() !== '') {
                    data['EJS_pathtodata'] = path2Data.value;
                    if (! data['EJS_pathtodata'].endsWith('/')) {
                        data['EJS_pathtodata'] += '/'
                    }
                } else {
                    data['EJS_pathtodata'] = 'https://rawcdn.githack.com/ethanaobrien/emulatorjs/main/data/';
                }
                if (! offline.checked) {
                    if (stateOnLoad.files[0]) {
                        data['EJS_loadStateURL'] = stateOnLoad.files[0].name;
                        zip.file(stateOnLoad.files[0].name, new Blob([stateOnLoad.files[0]]));
                    }
                    data['EJS_gameUrl'] = file.name;
                    zip.file(file.name, new Blob([file]));
                    if (biosFile.files[0]) {
                        data['EJS_biosUrl'] = biosFile.files[0].name;
                        zip.file(biosFile.files[0].name, new Blob([biosFile.files[0]]));
                    }
                    var spaces = '            ';
                    var fileData = '<html>\n    <head>\n        <!--HTML file auto generated using emulatorjs codehelper-->\n    </head>\n    <body>\n        <div style="width:640px;height:480px;max-width:100%">\n            <div id="game"></div>\n        </div>\n        <script>\n';
                    for (var k in data) {
                        if (data[k] === true || data[k] === false) {
                            fileData += (spaces + k + ' = ' + data[k] + ';\n');
                        } else {
                            fileData += (spaces + k + ' = "' + data[k] + '";\n');
                        }
                    }
                    fileData += '        </scr'+'ipt>\n        <script src="'+data['EJS_pathtodata']+'loader.js"></scr'+'ipt>\n    </body>\n</html>'
                } else if (document.getElementById('offlinePack').checked) {
                    data['EJS_gameUrl'] = 'URL.createObjectURL(new Blob([Uint8Array.from(window.gameData)]))';
                    var b = JSON.stringify(Array.from(new Uint8Array(await (new Blob([file])).arrayBuffer())));
                    var spaces = '            ';
                    var a = spaces + 'window.gameData = '+b+';\n';
                    var fileData = '<html>\n    <head>\n        <!--HTML file auto generated using emulatorjs codehelper-->\n    </head>\n    <body>\n        <div style="width:640px;height:480px;max-width:100%">\n            <div id="game"></div>\n        </div>\n        <script>\n';
                    fileData += a;
                    for (var k in data) {
                        if (data[k] === true || data[k] === false || k === 'EJS_gameUrl') {
                            fileData += (spaces + k + ' = ' + data[k] + ';\n');
                        } else {
                            fileData += (spaces + k + ' = "' + data[k] + '";\n');
                        }
                    }
                    fileData += '        </scr'+'ipt>\n        <script src="'+data['EJS_pathtodata']+'loader.js"></scr'+'ipt>\n    </body>\n</html>'
                } else {
                    data['EJS_gameUrl'] = 'URL.createObjectURL(new Blob([Uint8Array.from(window.gameData)]))';
                    var b = JSON.stringify(Array.from(new Uint8Array(await (new Blob([file])).arrayBuffer())));
                    zip.file('gameData.js', 'window.gameData = '+b+'\n');
                    var spaces = '            ';
                    var fileData = '<html>\n    <head>\n        <!--HTML file auto generated using emulatorjs codehelper-->\n    </head>\n    <body>\n        <div style="width:640px;height:480px;max-width:100%">\n            <div id="game"></div>\n        </div>\n        <script src="gameData.js"></scr'+'ipt>\n        <script>\n';
                    for (var k in data) {
                        if (data[k] === true || data[k] === false || k === 'EJS_gameUrl') {
                            fileData += (spaces + k + ' = ' + data[k] + ';\n');
                        } else {
                            fileData += (spaces + k + ' = "' + data[k] + '";\n');
                        }
                    }
                    fileData += '        </scr'+'ipt>\n        <script src="'+data['EJS_pathtodata']+'loader.js"></scr'+'ipt>\n    </body>\n</html>'
                    
                }
                zip.file('index.html', new Blob([fileData]))
                document.getElementById('select2').style = "display:none;";
                document.getElementById('zipStatus').style = "display:block;";
                zip.generateAsync({type:"blob"}, function updateCallback(metadata) {
                    var zipStatus = metadata.percent.toFixed(2)+'%';
                    document.getElementById('zs1').innerHTML = ' '+zipStatus+' ';
                    document.getElementById('zs1').value = metadata.percent.toFixed(2);
                    document.getElementById('zs2').innerHTML = zipStatus;
                }).then(function(blob) {
                    document.getElementById('outLink').href = URL.createObjectURL(blob);
                    document.getElementById('outLink').download = 'OUT-'+file.name.split('.')[0]+'.zip';
                    document.getElementById('downloadScreen').style = "display:block;";
                    document.getElementById('zipStatus').style = "display:none;";
                })
            })
        </script>
    </body>
</html>
